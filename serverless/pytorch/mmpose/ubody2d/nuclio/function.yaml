metadata:
  name: pth-mmpose-ubody
  namespace: cvat
  annotations:
    name: UBody via MMPose
    type: detector
    framework: pytorch
    spec: |
      [
        {
          "id": 0,
          "name": "person",
          "elements": [
              {
                  "id": 1,
                  "name": "1"
              },
              {
                  "id": 2,
                  "name": "2"
              },
              {
                  "id": 3,
                  "name": "3"
              },
              {
                  "id": 4,
                  "name": "4"
              },
              {
                  "id": 5,
                  "name": "5"
              },
              {
                  "id": 6,
                  "name": "6"
              },
              {
                  "id": 7,
                  "name": "7"
              },
              {
                  "id": 8,
                  "name": "8"
              },
              {
                  "id": 9,
                  "name": "9"
              },
              {
                  "id": 10,
                  "name": "10"
              },
              {
                  "id": 11,
                  "name": "11"
              },
              {
                  "id": 12,
                  "name": "12"
              },
              {
                  "id": 13,
                  "name": "13"
              },
              {
                  "id": 14,
                  "name": "14"
              },
              {
                  "id": 15,
                  "name": "15"
              },
              {
                  "id": 16,
                  "name": "16"
              },
              {
                  "id": 17,
                  "name": "17"
              }
          ]
        }
      ]

spec:
  description: Whole Body points
  runtime: 'python:3.8'
  handler: main:handler
  eventTimeout: 30s

  build:
    image: cvat.pth.mmpose-ubody
    baseImage: python:3.8

    directives:
      preCopy:
        - kind: RUN
          value: apt update && apt install -y curl git libgl1 --no-install-recommends && rm -rf /var/lib/apt/lists/*
        - kind: WORKDIR
          value: /opt/nuclio
        - kind: RUN
          value: pip install torch==2.0.0+cpu torchvision==0.15.1+cpu -f https://download.pytorch.org/whl/torch_stable.html
        - kind: RUN
          value: pip install -U cython openmim && mim install mmengine && mim install "mmcv==2.0.1" && mim install "mmdet==3.2.0" && mim install "mmpose==1.2.0"
        - kind: RUN
          value: git clone https://github.com/open-mmlab/mmpose && cd mmpose && git checkout v1.2.0
        - kind: RUN
          value: curl -o td-hm_hrnet-w32_8xb64-210e_ubody-coco-256x192-7c227391_20230807.pth https://download.openmmlab.com/mmpose/v1/wholebody_2d_keypoint/ubody/td-hm_hrnet-w32_8xb64-210e_ubody-coco-256x192-7c227391_20230807.pth
        - kind: RUN
          value: curl -o rtmdet_nano_8xb32-100e_coco-obj365-person-05d8511e.pth https://download.openmmlab.com/mmpose/v1/projects/rtmpose/rtmdet_nano_8xb32-100e_coco-obj365-person-05d8511e.pth

  triggers:
    myHttpTrigger:
      maxWorkers: 2
      kind: 'http'
      workerAvailabilityTimeoutMilliseconds: 10000
      attributes:
        maxRequestBodySize: 33554432 # 32MB

  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
      mountMode: volume
